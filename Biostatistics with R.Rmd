---
title: "Biostatistics with R"
author: "Jamalludin Ab Rahman MD MPH"
output: 
  html_document: 
    toc: true
---

```{r Cascading style sheet, include=FALSE}
# The code below is a cascading style sheet for HTML webpage rendering
# It colors the text headers when this document is rendered as a web page
```

<style type="text/css">
h1 {color:#ffa500;}
h2 {color:#3364FF;}
h3 {color:#607CD5;}
h4 {color:#595A5D;}
</style>

```{r Setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
setwd(getwd())  # Setting the working directory
```

## Basic concepts for biostatistics

Biostatistics is the application of statistics in medicine, public health and biology. 

### Population and sample
### Variables and level of measurements
### Distribution of data
### Statistical inference
### Causality


## Quick introduction to R

R is an open source language environment used especially for statistical computing and graphics. It is free but while it is easily accessible to many, unless you are used to programming, it has a steep learning curve.

### Installing R and RStudio

Latest stable version of R can be downloaded from the Comprehensive R Archive Network (CRAN) (https://cran.r-project.org/mirrors.html). The installation process is pretty straight forward. Once R has been installed, you can also install RStudio (https://rstudio.com/products/rstudio/download/) which serve as a nice and user friendly interface to R scripts. There are many tutorials and videos showing the step-by-step process of installing and running R, so I will not be repeating them here. However I would like to highlight some tips that I feel will healp you to navigate R and RStudio better.

### RStudio interface

By default RStudio will show various panes in three divided areas. Console is where you  type your codes or commands. If you execute the command (by pressing enter or return key), text results will appear in the same console pane, graphics will appear in Plot pane and any new data structure or object will appear in Environment pane. 

You can also use a Script pane (by going to File>New File>R Script) to write your command. But you need to press Command+Return (or Control+Enter in Windows) to execute it. There are also various other panes in RStudio including Packages (where you can install and update them), Files (where you can navigate directory in your computer) and Help (to get some references obviously).

### R command structure

In general, to form a command, you apply function to an object. Functions in R are "first class objects", which means that they can be treated like any other object.

e.g.
object <- functions(<argument>)


### Data type and structure

The six basic data types in R are:

1. Character
2. Numeric
3. Integer
4. Logical
5. Complex
6. Raw

The five data structures are:

1. Atomic vector
2. List
3. Matrix
4. Data frame
5. Factors

## Data management in R

### Data creation

Data can be created using R manually especially for small databases. For big database, we can create them outside R and we can 'read' the data using R. 

## Descriptive statistics

### Summarising numerical values
### Summarising categorical values

## Analytical statistics

### Comparing numerical values
### Comparing categorical values
### Correlation

### Linear regression

What are the factors that significantly affecting systolic blood pressure (sbp)? We can examine the factors (X) that affect sbp by using linear regression because sbp, which is the dependent variable (Y), is a numerical values. To run linear regression, we need to fulfill few assumptions:

1. Linearity: The relationship between X and the mean of Y is linear.
2. Homoscedasticity: The variance of residual is the same for any value of X.
3. Independence: Observations are independent of each other.
4. Normality: For any fixed value of X, Y is normally distributed.

(Ref: https://sphweb.bumc.bu.edu/otlt/MPH-Modules/BS/R/R5_Correlation-Regression/R5_Correlation-Regression4.html)

#### Preparing the data
First we read healthstatus.csv file, and we should view its structure.

```{r Download the data}
library(readr)
library(dplyr)
healthstatus <- read_csv("https://raw.githubusercontent.com/profjamal/biostatistics/main/healthstatus.csv")
mydata <- healthstatus
attach(mydata)
mydata$sex <- factor(mydata$sex, labels = c("Male", "Female"))
mydata$exercise <- factor(mydata$exercise, labels = c("Low", "Moderate", "High"))
mydata$smoking <- factor(mydata$smoking, labels = c("No", "Yes"))

str(mydata)
```

#### Exercise 1

The objective of this exercise is to determine factors that are related with systolic blood pressure (sbp). There are 5 independent variables (predictors): age, sex, exercise, smoking and bmi.

##### Check for Normal distribution

We start by analysing the relationship of the two variables, sbp with age. First we need to determine the distribution of the variables.

The followings are method to determine distribution for sbp. 

```{r Visualising histogram - Method 1}
hist(sbp, main="Distribution of SBP", las=1) # Display histogram with y-axis showing the frequency
hist(sbp, main="Distribution of SBP", las=1, prob=TRUE) # Display the density, then only the normal curve line can be shown
curve(dnorm(x, mean=mean(sbp), sd=sd(sbp)), add=TRUE) # Showing Normal curve (based on density)
```

```{r Visualising histogram - Method 2}
library(ggplot2)
histo.sbp <- ggplot(mydata, aes(sbp)) +       #This is for count
              geom_histogram() +
              labs(title="Distribution of SBP",
                   x="SBP (mmHg)",
                   y="Count")+
              stat_bin(binwidth = 3)

histo.sbp 
```


```{r Q-Q Plot Method 1}
qqnorm(sbp)
qqline(sbp)

library(ggpubr)
ggqqplot(sbp)
```
From the q-q plot we can observed that the observed sbp are within the acceptable Normal distribution.

```{r Q-Q Plot Method 2}

qqplot.sbp <- ggplot(mydata, aes(sample=sbp)) +
              geom_qq() + geom_qq_line(color="red")

qqplot.sbp

```

Most of the observations are distributed along the straight line. We can deduce that sbp is normally distributed. We can also check normality using a Normality test like Shapiro Test.

```{r Normality test}
shapiro.test(sbp)
```

Shapiro-wilk test shows that sbp is normally distributed (P=0.074). Now, we should do the same for age. 

Next is to study the linear association or correlation between sbp and age.

```{r SBP vs. Age - Scatterplot}
plot(sbp~age, 
     main="Scatterplot between SBP and Age",
     xlab="Age (years)",
     ylab="SBP (mmHg)",
     las=1)
abline(lm(sbp~age), col="red")
```
##### Bivariate analysis

```{r SBP vs. Age - Correlation test}
cor.test(sbp, age)
```
This shows that the linearity assumption is not fulfilled. There is no correlation (r=-0.050, P=0.535). So we do not have to proceed with linear regression.

The next variable is sex. We can add categorical variable as independent variable in linear regression. We already tested this relationship using independent sample t test.

```{r SBP vs. Sex - Independent sample-t test}
t.test(sbp ~ sex)
```
The analysis shows that sbp is not affected by different sex (t(141.8)=0.426, P=0.6198).

Let us run simple linear regression between sbp and sex. It is 'simple' because there is only one independent variable (X).

```{r SBP vs. Sex - Linear regression}
model1 <- lm(sbp ~ sex)
summary(model1)
anova(model1)
```
There is no linear association between sbp and sex (F(1, 151)=0.182, P=0.669). 

How about sbp and exercise?

Since exercise has more than two categories, we can run one-way ANOVA which is a linear regression.

```{r SBP vs. Exercise - One-way ANOVA}
boxplot(sbp~exercise,
        xlab = "Exercise intensity", ylab = "SBP (mmHg)", las=1)
summary(aov(sbp~exercise))
```
There is a significant difference of sbp means by different exercise intensity (P=0.002). Therefore we need to identify which levels are actually different by running post-hoc test. 

```{r SBP vs. Exercise - Testing homogeinity}
library(car)
leveneTest(sbp ~ exercise, mydata, center=mean)
```
This shows that the variance of means in all the three different exercise intensity are the same.

```{r SBP vs. Exercise - Post-hoc test}
TukeyHSD(aov(sbp~exercise, mydata))
```
The analysis shows that the significant sbp difference was observed between High and Low intensity exercise only (P=0.006)

We can also do the same using linear regression.

```{r SBP vs. Exercise - Simple linear regression}
model1 <- lm(sbp ~ exercise, data=mydata)
summary(model1)
anova(model1)
```

In linear regression the result is a bit different. Both High and Moderate exercise intensity are signficantly related to svp (P=0.002 and P=0.044 respectively).

Next is determining relationship between sbp and smoking.

```{r SBP ~ Smoking - Simple linear regression}
model2 <- lm(sbp ~ smoking, data=mydata)
summary(model2)
anova(model2)
```

There is no relationship between sbp and smoking (F(1, 151)=0.6226, P=0.431).

```{r Calculating and creating a new variable BMI}
bmi <- wt / (ht/100)^2

bmistat <- ifelse(bmi < 18.5, "Underwight",
                  ifelse(bmi < 25, "Normal",
                         ifelse (bmi < 30, "Overweight", "Obese")))
mydata$bmi <- bmi
bmistat <- as.factor(bmistat)
mydata$bmistat <- bmistat
```

Now we need to analyse the relationship between sbp and bmistat.

```{r SBP ~ BMI status - Linear regression}
model3 <- lm(sbp ~ bmistat, data=mydata)
summary(model3)
anova(model3)
```

We are not able to find any significant relationship between bmi status and sbp. 

So far based on the bivariable analyses for between sbp with age, sex, exercise, smoking and bmi status, we only found exercise intensity as the significant explanatory variable for sbp.

### Multiple linear regression

In this exercise, we will use HbA1c as the outcome of the study, and the independent variables are age, sex, exercise, smoking, bmi status and blood pressure status.

```{r Distribution of hba1c}
hist(hba1c, main="Distribution of HBA1c")
ggqqplot(hba1c)
shapiro.test(hba1c)
```
Based on all the 3 analyses, we can conclude that hba1c is normally distributed.

Now, let us check what is BP status. For that we have to create a new variable called BP Status from sbp and dbp first.

```{r Compute and create BP Status variable}
bp <- sbp >= 140 | dbp >= 90
mydata$bp <- as.factor(bp)
```

#### Univariate model (unadjusted)

Let's check factors that are related to hba1c.
```{r hba1c~age}
summary(lm(hba1c~age, data=mydata))

```

```{r hba1c~sex}
summary(lm(hba1c~sex, data=mydata))

```

```{r hba1c~exercise}
summary(lm(hba1c~exercise, data=mydata))
```

```{r hba1c~smoking}
summary(lm(hba1c~smoking, data=mydata))
```

```{r hba1c~bmistat}
summary(lm(hba1c~bmistat, data=mydata))
```


```{r hba1c~bp}
t.test(hba1c~bp, data=mydata)
```

The simple linear regressions show that smoking and hypertension are associated with hba1c. Are they independent predictors for hba1c?


#### Multivariate model

```{r hba1c~smoking+bp}
model3 <- lm(sbp ~ smoking + bp, data=mydata)
summary(model3)
anova(model3)
library(car)
Anova(model3, type=3)
```

Based on the multiple linear regression, only bp is significantly associated with hba1c (P<0.0001)


#### Testing linear regression assumptions

```{r Testing assumptions}
mean(model3$residuals) ## Approaching zero

par(mfrow=c(2,2))
plot(model2) ## Contant residuals, or around zero = Homogenous

library(ggplot2)
acf(model2$residuals) # No auto correlation. Lag 0 always = 1, others hould be around 0

lmtest::dwtest(model2) # Durbin-Watson's test, P>0.05, no autocorrelation

```

```{r Testing assumptions using gvlma}
library(gvlma)
gvlma::gvlma(model3)


```


##### How to intepret gvlma?

Global Stat
Are the relationships between your X predictors and Y roughly linear?. Rejection of the null (p < .05) indicates a non-linear relationship between one or more of your X’s and Y

Skewness
Is your distribution skewed positively or negatively, necessitating a transformation to meet the assumption of normality? Rejection of the null (p < .05) indicates that you should likely transform your data.

Kurtosis
Is your distribution kurtotic (highly peaked or very shallowly peaked), necessitating a transformation to meet the assumption of normality? Rejection of the null (p < .05) indicates that you should likely transform your data.

Link Function
Is your dependent variable truly continuous, or categorical? Rejection of the null (p < .05) indicates that you should use an alternative form of the generalized linear model (e.g. logistic or binomial regression).

Heteroscedasticity
Is the variance of your model residuals constant across the range of X (assumption of homoscedastiity)? Rejection of the null (p < .05) indicates that your residuals are heteroscedastic, and thus non-constant across the range of X. Your model is better/worse at predicting for certain ranges of your X scales.


### Logistic regression
### Repeated measures analysis

